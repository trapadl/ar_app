<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>bar challenge quiz - overlay</title>
    <!-- Import Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* Basic Reset & Dark Mode Theme */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; overflow: hidden; /* Prevent body scroll */ }
        body { display: flex; justify-content: center; align-items: flex-start; padding-top: 0; /* Remove top padding */ }

        #app {
            width: 100%; max-width: 100%; /* Allow app to fill screen width */
            height: 100%; /* Allow app to fill screen height */
            max-height: 100vh; /* Ensure it respects viewport height */
            background-color: #1e1e1e;
            /* Remove padding, border, shadow if panel fills screen */
            padding: 0; border: none; box-shadow: none;
            text-align: center;
            display: flex; flex-direction: column;
            position: relative; /* Needed for absolute positioning inside */
        }

        /* Logo Placeholder - Positioned absolute for overlay */
        .logo-placeholder {
            position: absolute; top: 15px; left: 15px;
            width: 100px; height: auto; /* Adjust size */
            z-index: 15; /* Above other overlays */
            opacity: 0.8;
            /* Removed background/border for cleaner overlay */
        }
        .logo-placeholder img { max-width: 100%; height: auto; display: block; }


        /* Panel Visibility Control - Panels now fill the app container */
        .panel {
            display: none; flex-direction: column; align-items: center;
            width: 100%; height: 100%; flex-grow: 1;
            position: absolute; /* Panels stack */
            top: 0; left: 0;
            background-color: #1e1e1e; /* Default panel background */
            overflow-y: auto; /* Allow scrolling within panels if needed */
            padding: 20px; /* Add padding back to panels */
            justify-content: center; /* Center content vertically by default */
        }
        .panel.active { display: flex; z-index: 10; /* Active panel on top */ }

        /* Landing panel specific alignment */
        #panel-landing { justify-content: center; }

        /* Quiz panel specific styles */
        #panel-quiz {
            padding: 0; /* Remove padding, content will be positioned */
            background-color: transparent; /* Make panel background transparent */
            justify-content: flex-start; /* Align content towards top */
        }

        /* Video Background */
        #camera-feed {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover; /* Cover the area, may crop */
            z-index: 1; /* Behind the UI overlay */
            /* Consider mirroring if using front camera by default: */
            /* transform: scaleX(-1); */
        }

        /* Quiz UI Overlay Container */
        #quiz-content-overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2; /* Above video feed */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Push elements to top and bottom */
            padding: 15px; /* Padding around the overlay edges */
            pointer-events: none; /* Allow clicks through container */
        }
        #quiz-content-overlay > * {
            pointer-events: auto; /* Enable interaction for children */
        }

        /* Top Section of Overlay (Timer, Indicator) */
        .quiz-overlay-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }

        /* Bottom Section of Overlay (Instructions, Question, Input, Button) */
        .quiz-overlay-bottom {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background-color: rgba(20, 20, 20, 0.85); /* Semi-transparent dark background */
            padding: 15px;
            border-radius: 8px;
            max-width: 95%;
            margin: 0 auto; /* Center horizontally */
        }


        /* Common Elements (Adapted for Dark Mode / Overlay) */
        h1, h2, h3, h4 { margin-bottom: 15px; color: #ffffff; }
        p { margin-bottom: 15px; line-height: 1.6; text-align: left; width: 100%; color: #e0e0e0; }
        ol, ul { text-align: left; margin-left: 20px; /* Less indent */ margin-bottom: 15px; color: #e0e0e0; padding-left: 0; }
        li { margin-bottom: 8px; }

        button {
            display: inline-block; background-color: #e0e0e0; color: #121212;
            padding: 10px 20px; /* Slightly smaller padding */ border: 1px solid #e0e0e0; border-radius: 5px;
            font-size: 15px; /* Slightly smaller font */ font-weight: bold; cursor: pointer; margin-top: 10px;
            margin-bottom: 5px; /* Less bottom margin */ transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            width: 90%; max-width: 280px;
        }
        button:hover { background-color: #ffffff; border-color: #ffffff; }
        button:disabled { background-color: #444444; color: #888888; border-color: #444444; cursor: not-allowed; }

        label { color: #e0e0e0; display: block; margin-bottom: 5px; text-align: left; width: 100%; font-size: 14px; }

        input[type="text"], input[type="email"] {
            padding: 8px 10px; /* Slightly smaller padding */ margin-bottom: 10px; border: 1px solid #555555;
            border-radius: 4px; width: 100%; font-size: 15px; background-color: #2c2c2c; color: #e0e0e0;
        }
         input[type="text"]::placeholder, input[type="email"]::placeholder { color: #888888; }

        .error-message { color: #ff8a80; margin-top: 5px; /* Less margin */ font-weight: bold; font-size: 14px; }
        .info-message { color: #80cbc4; margin-top: 5px; font-size: 13px; }
        .success-message { color: #a5d6a7; margin-top: 5px; font-weight: bold; font-size: 14px; }

        /* Quiz Overlay Specific Elements */
        #quiz-timer-overlay {
            font-size: 1.6em; font-weight: bold; color: #ffffff;
            background-color: rgba(0, 0, 0, 0.6); padding: 5px 10px; border-radius: 5px;
        }
        #recording-indicator {
             background-color: #ff4d4d; color: white; padding: 3px 8px; border-radius: 10px; font-size: 12px; animation: pulse 1.5s infinite;
             /* display: none; */ /* Handled by JS */
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        #quiz-instructions-overlay { margin-bottom: 10px; max-height: 120px; overflow-y: auto; padding-right: 10px; /* Space for scrollbar */ }
        #quiz-instructions-overlay p, #quiz-instructions-overlay ol { margin-bottom: 5px; font-size: 14px; line-height: 1.5; }
        #quiz-question-overlay { font-weight: bold; margin-bottom: 10px; font-size: 1.0em; color: #ffffff; }

        /* Leaderboard Styles (for finish/final panels) */
        .leaderboard-panel-content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 450px; /* Limit content width */ }
        #leaderboard-container { margin-top: 15px; width: 100%; max-height: 40vh; overflow-y: auto; border: 1px solid #444; background-color: #2c2c2c; }
        #leaderboard-table { width: 100%; border-collapse: collapse; }
        #leaderboard-table th, #leaderboard-table td { border: 1px solid #555; padding: 6px; text-align: left; color: #e0e0e0; font-size: 14px; }
        #leaderboard-table th { background-color: #383838; position: sticky; top: 0; z-index: 1; color: #ffffff; }
         #leaderboard-table td:nth-child(1), #leaderboard-table th:nth-child(1) { width: 15%; }
         #leaderboard-table td:nth-child(3), #leaderboard-table th:nth-child(3) { width: 25%; }
        .blurred-text { filter: blur(5px); opacity: 0.7; user-select: none; cursor: default; }
        #leaderboard-table td.blurred-time { filter: blur(5px); opacity: 0.7; }

        #panel-finish .leaderboard-prompt { margin-top: 20px; font-weight: bold; }
        #panel-finish #leaderboard-container { margin-bottom: 10px; }
        #panel-finish .info-message { margin-top: 5px; }

        /* Ensure buttons in finish/leaderboard panels fit content width */
        #panel-finish button, #panel-final-leaderboard button { width: 100%; }

    </style>
</head>
<body>
    <!-- App Container -->
    <div id="app">

        <!-- Logo Placeholder (Absolute Position) -->
        <div class="logo-placeholder">
            <img src="./Asset 2.png" alt="your bar logo" >
        </div>

        <!-- 1. Landing Panel -->
        <div id="panel-landing" class="panel active">
            <div class="leaderboard-panel-content"> <!-- Reuse centering style -->
                <h4>best cocktail bar in adelaide 2024..</h4><br><br>
                <p style="text-align: center;">follow the instructions and answer the questions to find something cool..</p>

                <!-- Recording Toggle -->
                <div style="margin: 15px 0; text-align: center;">
                    <input type="checkbox" id="record-checkbox" style="vertical-align: middle;" checked> <!-- Default ON -->
                    <label for="record-checkbox" style="display: inline; margin-left: 5px; max-width: none; text-align: center;">record your experience (optional)</label>
                </div>
                <p id="record-warning" class="info-message" style="font-size: 12px; text-align: center;">requires camera & microphone permission</p>

                <button id="btn-start-quiz">start.</button>
            </div>
        </div>

        <!-- 2. Quiz Panel (Contains Video and Overlay) -->
        <div id="panel-quiz" class="panel">
            <!-- Video Feed Background -->
            <video id="camera-feed" playsinline autoplay muted style="display: none;"></video> <!-- Start hidden -->

            <!-- Quiz UI Overlay -->
            <div id="quiz-content-overlay" style="display: none;"> <!-- Start hidden -->
                <!-- Top Section -->
                <div class="quiz-overlay-top">
                    <div id="quiz-timer-overlay">time: <span id="timer-display">0.0</span>s</div>
                    <div id="recording-indicator" style="display: none;">● recording</div>
                </div>

                <!-- Bottom Section -->
                <div class="quiz-overlay-bottom">
                    <div id="quiz-instructions-overlay"></div>
                    <div id="quiz-question-overlay"></div>
                    <label for="quiz-answer-input" style="margin-top:10px;">your answer:</label>
                    <input type="text" id="quiz-answer-input" placeholder="type your answer">
                    <p id="quiz-error" class="error-message"></p>
                    <button id="quiz-submit-answer">submit answer</button>
                </div>
            </div>
        </div>

        <!-- 3. Finish Panel with Blurred Leaderboard -->
        <div id="panel-finish" class="panel">
            <div class="leaderboard-panel-content"> <!-- Reuse centering style -->
                <h2>challenge complete!</h2>
                <p>your final time is: <strong id="final-time">0.0</strong> seconds!</p>
                <h3>top times</h3>
                <div id="leaderboard-container">
                    <table id="leaderboard-table">
                        <thead> <tr><th>rank</th><th>name</th><th>time (s)</th></tr> </thead>
                        <tbody id="leaderboard-body">
                            <tr><td colspan="3" style="text-align:center;">loading scores...</td></tr>
                        </tbody>
                    </table>
                </div>
                <p class="leaderboard-prompt">want to add your time to the leaderboard?</p>
                <label for="user-name">name:</label>
                <input type="text" id="user-name" placeholder="your name">
                <label for="user-email">email:</label>
                <input type="email" id="user-email" placeholder="your.email@example.com">
                <button id="btn-join-leaderboard">join leaderboard</button>
                <p id="upload-status" class="info-message" style="margin-top: 15px; font-weight: bold;"></p>
                <p id="leaderboard-submit-status" class="info-message"></p>
                <p class="info-message">(if not, simply close this page)</p>
            </div>
        </div>

        <!-- 4. Final (Unblurred) Leaderboard Panel -->
        <div id="panel-final-leaderboard" class="panel">
             <div class="leaderboard-panel-content"> <!-- Reuse centering style -->
                <h2 id="final-message">you're on the leaderboard!</h2>
                <h3>top times</h3>
                <div id="leaderboard-container">
                    <table id="leaderboard-table">
                        <thead> <tr><th>rank</th><th>name</th><th>time (s)</th></tr> </thead>
                        <tbody id="leaderboard-body-final">
                            <tr><td colspan="3" style="text-align:center;">loading scores...</td></tr>
                        </tbody>
                    </table>
                </div>
                 <button id="btn-play-again" style="margin-top: 20px;">play again</button>
             </div>
        </div>

        <!-- 5. Error Panel -->
        <div id="panel-error" class="panel">
             <div class="leaderboard-panel-content"> <!-- Reuse centering style -->
                 <h2>oops! something went wrong.</h2>
                 <p id="error-details" style="text-align:center;">an error occurred.</p>
                 <button id="btn-error-back">go back to start</button>
            </div>
        </div>

    </div> <!-- End #app -->

    <script>
        /*****************************************
         *           CONFIGURATION               *
         *****************************************/
         const SUPABASE_URL = "https://hdagjajchjxsyytdlqzi.supabase.co";
         const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkYWdqYWpjaGp4c3l5dGRscXppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDMyOTE3NjEsImV4cCI6MjA1ODg2Nzc2MX0.8A5dhEKfDbUOeouvp_e32rMR-NUwnUjBTuP-8tEtsYU";
         const LEADERBOARD_LIMIT = 10;
         const STORAGE_BUCKET_NAME = "racerecordings"; // <<< YOUR BUCKET NAME

        // --- QUIZ CONTENT ---
        const quizSteps = [
             { instructions: `<p>first set of directions:</p><ol><li>face the main road.</li><li>turn 90 degrees to the right.</li><li>take about 20 steps towards the street corner ahead.</li></ol><p>now, look at the prominent building across the road.</p>`, question: "what is the name of the hotel you're looking at?", answer: "sofitel", autocompleteTrigger: "sof", autocompleteValue: "sofitel" },
             { instructions: `<p>next directions:</p><ol><li>from where you answered the last question, turn 90 degrees to your right.</li><li>take about 20 steps until you reach the first alleyway entrance on your left.</li></ol><p>look at the sign or the general vibe of the laneway.</p>`, question: "what is the name of this colourful laneway?", answer: "cold chisel lane", autocompleteTrigger: "cold", autocompleteValue: "cold chisel lane" },
             { instructions: `<p>final stretch:</p><ol><li>walk down the laneway (cold chisel lane).</li><li>enter the first set of clearly open doors you find on your right hand side.</li></ol><p>you should now be inside the bar!</p>`, question: "approach the bar staff and ask politely: \"what's the secret password?\"", answer: "negroni", autocompleteTrigger: null, autocompleteValue: null }
        ];

        /*****************************************
         *        DOM ELEMENT REFERENCES         *
         *****************************************/
        const app = document.getElementById('app');
        const panels = { landing: document.getElementById('panel-landing'), quiz: document.getElementById('panel-quiz'), finish: document.getElementById('panel-finish'), finalLeaderboard: document.getElementById('panel-final-leaderboard'), error: document.getElementById('panel-error') };
        const btnStartQuiz = document.getElementById('btn-start-quiz');
        const recordCheckbox = document.getElementById('record-checkbox');
        const recordWarning = document.getElementById('record-warning');
        const cameraFeed = document.getElementById('camera-feed'); // Video element
        const quizContentOverlay = document.getElementById('quiz-content-overlay'); // UI Overlay div
        const quizTimerDisplay = document.getElementById('timer-display');
        const recordingIndicator = document.getElementById('recording-indicator');
        const quizInstructionsDiv = document.getElementById('quiz-instructions-overlay'); // Target overlay element
        const quizQuestionDiv = document.getElementById('quiz-question-overlay'); // Target overlay element
        const quizAnswerInput = document.getElementById('quiz-answer-input');
        const quizErrorMsg = document.getElementById('quiz-error');
        const quizSubmitBtn = document.getElementById('quiz-submit-answer');
        const finalTimeDisplay = document.getElementById('final-time');
        const userNameInput = document.getElementById('user-name');
        const userEmailInput = document.getElementById('user-email');
        const btnJoinLeaderboard = document.getElementById('btn-join-leaderboard');
        const uploadStatus = document.getElementById('upload-status');
        const leaderboardSubmitStatus = document.getElementById('leaderboard-submit-status');
        const leaderboardBodyBlurred = document.getElementById('leaderboard-body');
        const finalMessage = document.getElementById('final-message');
        const leaderboardBodyFinal = document.getElementById('leaderboard-body-final');
        const btnPlayAgain = document.getElementById('btn-play-again');
        const errorDetails = document.getElementById('error-details');
        const btnErrorBack = document.getElementById('btn-error-back');

        /*****************************************
         *           APPLICATION STATE           *
         *****************************************/
        let supabaseClient = null;
        let currentPanel = 'landing';
        let currentStepIndex = 0;
        let startTime = null; let endTime = null; let finalTimeSeconds = 0; let timerInterval = null;
        let userWantsToRecord = true; // Default ON
        let mediaRecorder = null; let recordedChunks = []; let videoBlob = null;
        let mediaStream = null; let isRecordingActive = false; let uploadInProgress = false;

        /*****************************************
         *         INITIALIZATION                *
         *****************************************/
        async function initializeApp() {
            userWantsToRecord = recordCheckbox.checked; // Sync state with default checkbox
            recordWarning.style.display = userWantsToRecord ? 'block' : 'none';
            if (!initializeSupabase()) return;
            await logAppOpen();
            setupEventListeners();
            showPanel('landing');
            console.log("quiz app initialized (overlay mode).");
        }

        function initializeSupabase() {
             if (!SUPABASE_URL || !SUPABASE_ANON_KEY ) { console.error("config error: supabase credentials missing."); return false; }
             if (typeof supabase === 'undefined' || !supabase.createClient) { console.error("runtime error: supabase library not loaded."); return false; }
            try { supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); console.log("supabase client initialized."); return true; }
            catch (error) { console.error(`database connection failed: ${error.message}`); return false; }
        }

        function setupEventListeners() {
            btnStartQuiz.addEventListener('click', handleStartQuizClick);
            recordCheckbox.addEventListener('change', (e) => {
                userWantsToRecord = e.target.checked;
                recordWarning.style.display = userWantsToRecord ? 'block' : 'none';
            });
             quizSubmitBtn.addEventListener('click', handleAnswerSubmit);
             quizAnswerInput.addEventListener('input', handleAnswerInput);
             quizAnswerInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAnswerSubmit(); });
            btnJoinLeaderboard.addEventListener('click', handleJoinLeaderboard);
            if (btnPlayAgain) { btnPlayAgain.addEventListener('click', resetToLanding); }
            btnErrorBack.addEventListener('click', resetToLanding);
            console.log("event listeners attached.");
        }

        /*****************************************
         *          UI / Panel Management        *
         *****************************************/
        function showPanel(panelName) {
            console.log("showing panel:", panelName);
            Object.values(panels).forEach(panel => panel.classList.remove('active'));
            if (panels[panelName]) {
                panels[panelName].classList.add('active');
                currentPanel = panelName;
                window.scrollTo(0, 0); // Less relevant now but keep
            } else { console.error("panel not found:", panelName); panels.landing.classList.add('active'); currentPanel = 'landing'; }
        }

        function showErrorPanel(message) {
            stopTimer();
            stopRecordingCleanup(); // Ensure recording stops on error
            errorDetails.textContent = message;
            showPanel('error');
        }

        /*****************************************
         *           START & QUIZ LOGIC          *
         *****************************************/
         async function handleStartQuizClick() {
            btnStartQuiz.disabled = true; btnStartQuiz.textContent = 'starting...';
            try {
                // Always request camera now to show feed
                await requestMediaPermissionsAndShowFeed();
                if (userWantsToRecord) {
                    startRecordingInternal(); // Start recorder if needed
                }
                startQuizGameplay(); // Proceed to quiz UI
            } catch (error) {
                showErrorPanel(`failed to start: ${error.message}. please check camera/mic permissions.`);
                btnStartQuiz.disabled = false; btnStartQuiz.textContent = 'start.';
            }
         }

        function startQuizGameplay() {
            console.log("starting quiz gameplay...");
            currentStepIndex = 0; finalTimeSeconds = 0;
            quizTimerDisplay.textContent = '0.0';
            if (timerInterval) clearInterval(timerInterval); timerInterval = null; startTime = null;
            uploadStatus.textContent = '';
            recordingIndicator.style.display = isRecordingActive ? 'block' : 'none';

            displayStep(currentStepIndex);
            showPanel('quiz');
            quizContentOverlay.style.display = 'flex'; // Show the UI overlay

            // Ensure video plays (should already have stream)
            if(cameraFeed.paused) {
                cameraFeed.play().catch(e => console.warn("Video play failed (might need interaction):", e));
            }

            startTimer();
            btnStartQuiz.disabled = false; btnStartQuiz.textContent = 'start.';
        }

        function displayStep(index) {
            if (index < 0 || index >= quizSteps.length) { showErrorPanel("internal error: invalid step index."); return; }
            const step = quizSteps[index];
            quizInstructionsDiv.innerHTML = step.instructions;
            quizQuestionDiv.textContent = step.question;
            quizAnswerInput.value = ''; quizErrorMsg.textContent = ''; quizAnswerInput.focus();
            console.log(`displaying step ${index + 1}`);
        }

        function handleAnswerSubmit() {
            const currentStep = quizSteps[currentStepIndex];
            const userAnswer = quizAnswerInput.value.trim().toLowerCase();
            const correctAnswer = currentStep.answer.toLowerCase();

            if (userAnswer === correctAnswer) {
                quizErrorMsg.textContent = ''; currentStepIndex++;
                if (currentStepIndex >= quizSteps.length) { finishQuiz(); }
                else { displayStep(currentStepIndex); }
            } else { quizErrorMsg.textContent = "that's not quite right, try again!"; }
        }

        function handleAnswerInput() {
            const currentStep = quizSteps[currentStepIndex];
            const input = quizAnswerInput.value.toLowerCase();
            if (currentStep.autocompleteTrigger && currentStep.autocompleteValue && input === currentStep.autocompleteTrigger) {
                quizAnswerInput.value = currentStep.autocompleteValue;
            }
             if (quizErrorMsg.textContent) quizErrorMsg.textContent = '';
        }

        function finishQuiz() {
            console.log("quiz finished!");
            stopTimer();
            finalTimeDisplay.textContent = finalTimeSeconds.toFixed(1);
            leaderboardSubmitStatus.textContent = '';
            userNameInput.value = ''; userEmailInput.value = '';
            quizContentOverlay.style.display = 'none'; // Hide overlay

            if (isRecordingActive && mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop(); // Triggers onstop -> handleRecordingStop
                isRecordingActive = false; // Mark inactive immediately
                recordingIndicator.style.display = 'none';
            } else {
                // If not recording, stop video feed and show results
                stopMediaStreamTracks(); // Stop camera if it was on but not recording
                if(cameraFeed) cameraFeed.style.display = 'none';
                showBlurredLeaderboard();
            }
        }

        /*****************************************
         *      MEDIA PERMISSIONS & RECORDING    *
         *****************************************/
        async function requestMediaPermissionsAndShowFeed() {
             console.log("Requesting media permissions for feed...");
             if (mediaStream) { // If stream already exists, stop old tracks first
                 stopMediaStreamTracks();
             }
             try {
                 mediaStream = await navigator.mediaDevices.getUserMedia({
                     video: { facingMode: "environment" }, audio: true // Get audio too for recording
                 });
                 console.log("Media permissions granted.");
                 cameraFeed.srcObject = mediaStream;
                 cameraFeed.style.display = 'block'; // Show video element
                 // Play might fail here if called too early, ensure it's called in startQuizGameplay
                 await cameraFeed.play().catch(e => { console.warn("Initial play attempt failed:",e); /* Will retry */});
             } catch (error) {
                 console.error("Error getting media stream:", error);
                 mediaStream = null; // Ensure stream is null on failure
                 throw new Error(error.message || "could not access camera/microphone");
             }
         }

         function startRecordingInternal() {
            if (!mediaStream) { console.error("Cannot start recording, no media stream."); return; }
            if (typeof MediaRecorder === 'undefined') { console.error("MediaRecorder not supported."); return; }

            try {
                const options = { mimeType: 'video/webm;codecs=vp8,opus' };
                 if (!MediaRecorder.isTypeSupported(options.mimeType)) { options.mimeType = 'video/mp4'; }
                 if (!MediaRecorder.isTypeSupported(options.mimeType)) { delete options.mimeType; }
                console.log("Recorder options:", options);

                recordedChunks = [];
                mediaRecorder = new MediaRecorder(mediaStream, options);
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = handleRecordingStop;
                mediaRecorder.onerror = (e) => { console.error("Recorder error:", e.error); stopRecordingCleanup(); };

                mediaRecorder.start(1000);
                isRecordingActive = true;
                console.log("MediaRecorder started.");
            } catch (error) {
                 console.error("Failed to initialize MediaRecorder:", error);
                 isRecordingActive = false; // Ensure flag is false if failed
                 // Optionally show an error to the user that recording failed but quiz continues
            }
        }

         function handleRecordingStop() {
             console.log("Recording stopped. Chunks:", recordedChunks.length);
             if (recordedChunks.length > 0) {
                 const mimeType = mediaRecorder?.mimeType || recordedChunks[0]?.type || 'video/webm';
                 videoBlob = new Blob(recordedChunks, { type: mimeType });
                 console.log("Video blob created, size:", videoBlob.size);
                 uploadRecording(); // Start upload
             } else {
                 console.warn("No data recorded.");
                 videoBlob = null;
             }
             // Cleanup happens AFTER blob creation / upload start
             stopRecordingCleanup(); // Also stops tracks and hides video feed
             showBlurredLeaderboard(); // Show finish UI
         }

        function stopRecordingCleanup() {
            console.log("Cleaning up recording state.");
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                try { mediaRecorder.stop(); } catch(e) { /* Ignore error stopping already stopped */ }
            }
            stopMediaStreamTracks();
            if(cameraFeed) { cameraFeed.style.display = 'none'; cameraFeed.srcObject = null; } // Hide video
            recordingIndicator.style.display = 'none';
            isRecordingActive = false; mediaRecorder = null; recordedChunks = [];
            // Keep videoBlob until upload attempt is finished
        }

        function stopMediaStreamTracks() {
             if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null; console.log("Media stream tracks stopped.");
            }
        }

        /*****************************************
         *        UPLOAD FUNCTION                *
         *****************************************/
        async function uploadRecording() {
            if (!supabaseClient || !videoBlob || videoBlob.size === 0) { return; }
            if (!STORAGE_BUCKET_NAME) { console.error("Storage bucket name not configured."); uploadStatus.textContent = "upload error: config."; uploadStatus.className = 'error-message'; return; }

            uploadInProgress = true;
            uploadStatus.textContent = "uploading video (0%)..."; uploadStatus.className = 'info-message'; uploadStatus.style.display = 'block';
            btnJoinLeaderboard.disabled = true;

            const fileName = `race-${Date.now()}.webm`;
            console.log(`Uploading ${fileName} to ${STORAGE_BUCKET_NAME}...`);

            try {
                const { data, error } = await supabaseClient.storage.from(STORAGE_BUCKET_NAME).upload(fileName, videoBlob, { upsert: false });
                if (error) throw new Error(error.message);
                console.log("Upload successful:", data);
                uploadStatus.textContent = "video upload complete!"; uploadStatus.className = 'success-message';
                videoBlob = null; // Clear blob
            } catch (error) {
                console.error("Upload failed:", error);
                uploadStatus.textContent = `video upload failed: ${error.message.substring(0, 50)}`; uploadStatus.className = 'error-message';
            } finally {
                uploadInProgress = false; btnJoinLeaderboard.disabled = false;
            }
        }

        /*****************************************
         *           TIMER FUNCTIONS             *
         *****************************************/
        function startTimer() { /* ... (same as before) ... */ }
        function stopTimer() { /* ... (same as before) ... */ }

        /*****************************************
         *        LEADERBOARD FUNCTIONS          *
         *****************************************/
        async function showBlurredLeaderboard() { /* ... (same as before) ... */ }
        function handleJoinLeaderboard() { /* ... (same, checks uploadInProgress) ... */ }
        async function saveLeaderboardEntry(name, email, time, statusElement, joinButton) { /* ... (same) ... */ }
        async function showFinalLeaderboard(didJoin) { /* ... (same, targets leaderboardBodyFinal) ... */ }

        /*****************************************
         *        RESET & UTILITY FUNCTIONS      *
         *****************************************/
        function resetToLanding() {
             stopTimer();
             stopRecordingCleanup(); // Full cleanup
             currentStepIndex = 0; startTime = null; endTime = null; finalTimeSeconds = 0;
             quizAnswerInput.value = ''; quizErrorMsg.textContent = '';
             userNameInput.value = ''; userEmailInput.value = ''; leaderboardSubmitStatus.textContent = '';
             btnJoinLeaderboard.disabled = false;
             leaderboardBodyBlurred.innerHTML = ''; leaderboardBodyFinal.innerHTML = '';
             userWantsToRecord = recordCheckbox.checked; // Resync with checkbox state
             uploadStatus.textContent = ''; uploadInProgress = false; videoBlob = null; // Clear upload state

             showPanel('landing');
             console.log("app reset to landing.");
        }

        /*****************************************
         *           INITIALIZE ON LOAD          *
         *****************************************/
        document.addEventListener('DOMContentLoaded', initializeApp);

        // --- App Open Log ---
        async function logAppOpen() { /* ... (same as before) ... */ }

        /* Notes:
         * 1. Quiz UI is now overlaid on live camera feed during the quiz.
         * 2. Recording toggle defaults ON, camera permission requested on start regardless.
         * 3. Recording uses the same stream shown in the video element.
         * 4. Cleanup logic stops tracks and hides video element.
         */
    </script>

</body>
</html>